<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitles generator</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 95%;
            box-sizing: border-box;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .header-logo {
            height: 45px;
            width: auto;
            vertical-align: middle;
            margin-right: 12px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(118, 75, 162, 0.3));
        }

        h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .error-message {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            animation: fadeIn 0.3s ease;
            font-weight: 500;
        }

        .error-message.show {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(248, 249, 255, 0.6);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .upload-area.error {
            border-color: #ef4444;
            background: rgba(254, 226, 226, 0.3);
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(240, 241, 255, 0.9);
            transform: scale(1.01);
            animation: pulse-border 1.5s infinite;
        }

        .upload-area.error:hover {
            border-color: #dc2626;
            animation: none;
        }

        .upload-icon {
            font-size: 56px;
            margin-bottom: 15px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .upload-area:hover .upload-icon {
            transform: translateY(-5px) scale(1.1);
        }

        .file-preview {
            animation: fadeIn 0.4s ease;
            width: 100%;
        }

        .file-preview-name {
            font-size: 18px;
            font-weight: 700;
            color: #4a4a4a;
            word-break: break-all;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .file-preview-type {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-size-info {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-text {
            color: #667eea;
            font-size: 16px;
            font-weight: 500;
        }

        .file-input {
            display: none;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        label {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #cancelBtn {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .progress-section {
            display: none;
            margin-top: 30px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-message {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #1565c0;
        }

        .result-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .result-content {
            display: none;
        }

        .result-content.active {
            display: block;
        }

        .result-text {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
            color: #333;
            white-space: pre-wrap;
        }

        .result-text::-webkit-scrollbar {
            width: 8px;
        }

        .result-text::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .result-text::-webkit-scrollbar-thumb {
            background: #764ba2;
            border-radius: 4px;
        }

        .result-text::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .copy-btn {
            flex: 1;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .download-btn {
            flex: 1;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .download-btn:hover {
            background: #0056b3;
        }

        .selected-file { 
            display: none !important; 
        }

        .range-container {
            margin-top: 10px;
            padding: 10px 0;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-top: -7px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
            
            .container {
                background: rgba(30, 30, 30, 0.9);
                color: #e0e0e0;
            }
            
            h1, .subtitle, label, .upload-text {
                color: #e0e0e0;
            }
            
            .result-text {
                background: #2a2a2a;
                color: #e0e0e0;
                border-color: #444;
            }
            
            select {
                background: #2a2a2a;
                color: #e0e0e0;
                border-color: #444;
            }
            
            .upload-area {
                background: rgba(40, 40, 60, 0.6);
            }
            
            .upload-area:hover, .upload-area.dragover {
                background: rgba(50, 50, 80, 0.9);
            }
            
            .tab {
                background: #2a2a2a;
                color: #e0e0e0;
            }
            
            .progress-message {
                color: #b0b0b0;
            }

            .file-preview-name {
                color: #e0e0e0;
            }

            .file-preview-type, .file-size-info {
                color: #999;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px
            }

            .options {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                width: 100%;
            }

            h1 {
                font-size: 24px;
            }

            .result-tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="header-logo">
            Subtitles generator
        </h1>
        <p class="subtitle">Drag and drop audio/video file or click to select</p>

        <div class="error-message" id="errorMessage"></div>

        <input type="file" id="fileInput" class="file-input" accept=".mp3,.wav,.m4a,.ogg,.mp4,.mov,.avi,.mkv" style="display:none">

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Click or drag and drop file here</div>
        </div>

        <div class="selected-file" id="selectedFile"></div>

        <div class="options">
            <div class="option-group">
                <label for="language">Language:</label>
                <select id="language">
                    <option value="auto">üåê Auto-detect</option>
                    <optgroup label="Popular">
                        <option value="uk">üá∫üá¶ Ukrainian</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="ru">üá∑üá∫ Russian</option>
                        <option value="es">üá™üá∏ Spanish</option>
                        <option value="fr">üá´üá∑ French</option>
                        <option value="de">üá©üá™ German</option>
                        <option value="it">üáÆüáπ Italian</option>
                        <option value="pt">üáµüáπ Portuguese</option>
                        <option value="ja">üáØüáµ Japanese</option>
                        <option value="zh">üá®üá≥ Chinese</option>
                        <option value="ko">üá∞üá∑ Korean</option>
                        <option value="ar">üá∏üá¶ Arabic</option>
                        <option value="pl">üáµüá± Polish</option>
                        <option value="tr">üáπüá∑ Turkish</option>
                        <option value="hi">üáÆüá≥ Hindi</option>
                    </optgroup>
                    <optgroup label="Other languages">
                        <option value="af">Afrikaans</option>
                        <option value="sq">Albanian</option>
                        <option value="am">Amharic</option>
                        <option value="hy">Armenian</option>
                        <option value="as">Assamese</option>
                        <option value="az">Azerbaijani</option>
                        <option value="ba">Bashkir</option>
                        <option value="eu">Basque</option>
                        <option value="be">Belarusian</option>
                        <option value="bn">Bengali</option>
                        <option value="bs">Bosnian</option>
                        <option value="br">Breton</option>
                        <option value="bg">Bulgarian</option>
                        <option value="my">Burmese</option>
                        <option value="ca">Catalan</option>
                        <option value="hr">Croatian</option>
                        <option value="cs">Czech</option>
                        <option value="da">Danish</option>
                        <option value="nl">Dutch</option>
                        <option value="et">Estonian</option>
                        <option value="fo">Faroese</option>
                        <option value="fi">Finnish</option>
                        <option value="gl">Galician</option>
                        <option value="ka">Georgian</option>
                        <option value="el">Greek</option>
                        <option value="gu">Gujarati</option>
                        <option value="ht">Haitian Creole</option>
                        <option value="ha">Hausa</option>
                        <option value="haw">Hawaiian</option>
                        <option value="he">Hebrew</option>
                        <option value="hu">Hungarian</option>
                        <option value="is">Icelandic</option>
                        <option value="id">Indonesian</option>
                        <option value="ga">Irish</option>
                        <option value="jw">Javanese</option>
                        <option value="kn">Kannada</option>
                        <option value="kk">Kazakh</option>
                        <option value="km">Khmer</option>
                        <option value="lo">Lao</option>
                        <option value="la">Latin</option>
                        <option value="lv">Latvian</option>
                        <option value="ln">Lingala</option>
                        <option value="lt">Lithuanian</option>
                        <option value="lb">Luxembourgish</option>
                        <option value="mk">Macedonian</option>
                        <option value="mg">Malagasy</option>
                        <option value="ms">Malay</option>
                        <option value="ml">Malayalam</option>
                        <option value="mt">Maltese</option>
                        <option value="mi">Maori</option>
                        <option value="mr">Marathi</option>
                        <option value="mn">Mongolian</option>
                        <option value="ne">Nepali</option>
                        <option value="no">Norwegian</option>
                        <option value="nn">Nynorsk</option>
                        <option value="oc">Occitan</option>
                        <option value="ps">Pashto</option>
                        <option value="fa">Persian</option>
                        <option value="pa">Punjabi</option>
                        <option value="ro">Romanian</option>
                        <option value="sa">Sanskrit</option>
                        <option value="sr">Serbian</option>
                        <option value="sn">Shona</option>
                        <option value="sd">Sindhi</option>
                        <option value="si">Sinhala</option>
                        <option value="sk">Slovak</option>
                        <option value="sl">Slovenian</option>
                        <option value="so">Somali</option>
                        <option value="su">Sundanese</option>
                        <option value="sw">Swahili</option>
                        <option value="sv">Swedish</option>
                        <option value="tl">Tagalog</option>
                        <option value="tg">Tajik</option>
                        <option value="ta">Tamil</option>
                        <option value="tt">Tatar</option>
                        <option value="te">Telugu</option>
                        <option value="th">Thai</option>
                        <option value="bo">Tibetan</option>
                        <option value="tk">Turkmen</option>
                        <option value="ur">Urdu</option>
                        <option value="uz">Uzbek</option>
                        <option value="vi">Vietnamese</option>
                        <option value="cy">Welsh</option>
                        <option value="yi">Yiddish</option>
                        <option value="yo">Yoruba</option>
                    </optgroup>
                </select>
            </div>
            <div class="option-group">
                <label for="modelSize">Model:</label>
                <select id="modelSize">
                    <option value="tiny">Tiny (Fast)</option>
                    <option value="base" selected>Base (Optimal)</option>
                    <option value="small">Small (Accurate)</option>
                    <option value="medium">Medium (Very Accurate)</option>
                    <option value="large">Large (Most Accurate)</option>
                </select>
            </div>
            
            <div class="option-group" style="grid-column: span 2; margin-top: 15px;">
                <label for="maxWords" style="display: flex; justify-content: space-between;">
                    <span>Max words per subtitle:</span>
                    <b id="wordValue" style="color: #764ba2;">5</b>
                </label>
                <div class="range-container">
                    <input type="range" id="maxWords" min="1" max="25" value="5">
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 2px;">
                    <span>1 word (Short)</span>
                    <span>25 words (Maximum)</span>
                </div>
            </div>
        </div>

        <button class="btn" id="transcribeBtn" disabled>Start Transcription</button>
        <button class="btn" id="cancelBtn" style="display: none;">‚ùå Cancel Processing</button>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="progress-message" id="progressMessage">Processing...</div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-info" id="resultInfo"></div>
            
            <div class="result-tabs">
                <button class="tab active" onclick="showTab('full')">Full Text</button>
                <button class="tab" onclick="showTab('srt')">SRT Subtitles</button>
            </div>

            <div class="result-content active" id="fullTextContent">
                <div class="result-text" id="fullText"></div>
                <div class="action-buttons">
                    <button class="copy-btn" onclick="copyText('full')">üìã Copy</button>
                    <button class="download-btn" onclick="downloadText('full')">üíæ Download</button>
                </div>
            </div>

            <div class="result-content" id="srtContent">
                <div class="result-text" id="srtText"></div>
                <div class="action-buttons">
                    <button class="copy-btn" onclick="copyText('srt')">üìã Copy</button>
                    <button class="download-btn" onclick="downloadText('srt')">üíæ Download SRT</button>
                </div>
            </div>
        </div>
    </div>

<script>
    let selectedFile = null;
    let currentTaskId = null;
    let currentResult = null;
    let progressCheckInterval = null;
    let uploadXHR = null;

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const progressSection = document.getElementById('progressSection');
    const resultSection = document.getElementById('resultSection');
    const wordSlider = document.getElementById('maxWords');
    const wordValueDisplay = document.getElementById('wordValue');
    const errorMessage = document.getElementById('errorMessage');

    const MAX_FILE_SIZE = 500 * 1024 * 1024;

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
    }

    function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function saveUserPreferences() {
        localStorage.setItem('whisper_language', document.getElementById('language').value);
        localStorage.setItem('whisper_model', document.getElementById('modelSize').value);
        localStorage.setItem('whisper_max_words', wordSlider.value);
    }

    window.addEventListener('load', () => {
        const savedLang = localStorage.getItem('whisper_language');
        const savedModel = localStorage.getItem('whisper_model');
        const savedWords = localStorage.getItem('whisper_max_words');
        
        if (savedLang) document.getElementById('language').value = savedLang;
        if (savedModel) document.getElementById('modelSize').value = savedModel;
        if (savedWords) {
            wordSlider.value = savedWords;
            wordValueDisplay.innerHTML = savedWords >= 25 ? "25" : savedWords;
        }
    });

    function showError(message) {
        errorMessage.textContent = '‚ùå ' + message;
        errorMessage.classList.add('show');
        uploadArea.classList.add('error');
        
        setTimeout(() => {
            errorMessage.classList.remove('show');
            uploadArea.classList.remove('error');
        }, 5000);
    }

    function hideError() {
        errorMessage.classList.remove('show');
        uploadArea.classList.remove('error');
    }

    function handleFileSelect(e) {
        const files = e.target.files || (e.dataTransfer && e.dataTransfer.files);
        if (files && files.length > 0) {
            const file = files[0];
            
            if (file.size > MAX_FILE_SIZE) {
                showError(`File too large! Maximum size is ${formatFileSize(MAX_FILE_SIZE)}. Your file: ${formatFileSize(file.size)}`);
                fileInput.value = '';
                return;
            }

            const validExtensions = ['mp3', 'wav', 'm4a', 'ogg', 'mp4', 'mov', 'avi', 'mkv'];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExt)) {
                showError(`Invalid file type! Supported formats: ${validExtensions.join(', ')}`);
                fileInput.value = '';
                return;
            }

            hideError();
            selectedFile = file;
            updateDropzoneUI(file);
            transcribeBtn.disabled = false;
        }
    }

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFileSelect(e);
    });

    wordSlider.oninput = function() {
        wordValueDisplay.innerHTML = (this.value >= 25) ? "25" : this.value;
    };

    document.getElementById('language').addEventListener('change', saveUserPreferences);
    document.getElementById('modelSize').addEventListener('change', saveUserPreferences);
    wordSlider.addEventListener('change', saveUserPreferences);

    function updateDropzoneUI(file) {
        const fileName = file.name;
        const fileExt = fileName.split('.').pop().toLowerCase();
        const fileSize = formatFileSize(file.size);
        let icon = 'üìÅ'; 
        let typeText = 'FILE';

        const audioExts = ['mp3', 'wav', 'm4a', 'ogg'];
        const videoExts = ['mp4', 'mov', 'avi', 'mkv'];

        if (audioExts.includes(fileExt)) {
            icon = 'üéµ';
            typeText = 'AUDIO FILE';
        } else if (videoExts.includes(fileExt)) {
            icon = 'üé¨';
            typeText = 'VIDEO FILE';
        }

        uploadArea.innerHTML = `
            <div class="file-preview">
                <div class="upload-icon">${icon}</div>
                <div class="file-preview-name">${fileName}</div>
                <div class="file-preview-type">${typeText}</div>
                <div class="file-size-info">${fileSize}</div>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">(Click to change)</div>
            </div>
        `;
        
        if (audioExts.includes(fileExt)) {
            const audioURL = URL.createObjectURL(file);
            uploadArea.innerHTML += `
                <audio controls style="margin-top: 15px; width: 100%; max-width: 400px;">
                    <source src="${audioURL}" type="audio/${fileExt}">
                </audio>
            `;
        }
    }

    transcribeBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('language', document.getElementById('language').value);
        formData.append('model_size', document.getElementById('modelSize').value);
        formData.append('max_words', wordSlider.value);

        transcribeBtn.style.display = 'none';
        cancelBtn.style.display = 'block';
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';
        hideError();

        const progressBar = document.getElementById('progressBar');
        const progressMessage = document.getElementById('progressMessage');

        try {
            uploadXHR = new XMLHttpRequest();

            uploadXHR.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete / 2 + '%';
                    progressBar.textContent = Math.round(percentComplete / 2) + '%';
                    progressMessage.textContent = `Uploading: ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)}`;
                }
            });

            uploadXHR.addEventListener('load', () => {
                if (uploadXHR.status === 200) {
                    const data = JSON.parse(uploadXHR.responseText);
                    
                    if (data.error) {
                        showError(data.error);
                        resetUI();
                        return;
                    }

                    currentTaskId = data.task_id;
                    checkProgress();
                } else {
                    throw new Error(`Server error: ${uploadXHR.status} ${uploadXHR.statusText}`);
                }
            });

            uploadXHR.addEventListener('error', () => {
                showError('Upload failed. Please check your connection.');
                resetUI();
            });

            uploadXHR.open('POST', '/upload');
            uploadXHR.send(formData);

        } catch (error) {
            console.error('Upload error:', error);
            showError(`Upload failed: ${error.message}. Please try a smaller file or check your connection.`);
            resetUI();
        }
    });

    cancelBtn.addEventListener('click', () => {
        if (uploadXHR) {
            uploadXHR.abort();
        }
        if (progressCheckInterval) {
            clearTimeout(progressCheckInterval);
        }
        showError('Processing cancelled by user');
        resetUI();
    });

    function resetUI() {
        transcribeBtn.style.display = 'block';
        cancelBtn.style.display = 'none';
        transcribeBtn.disabled = false;
        progressSection.style.display = 'none';
    }

    async function checkProgress() {
        try {
            const response = await fetch(`/progress/${currentTaskId}`);
            
            if (!response.ok) {
                throw new Error(`Progress check failed: ${response.status}`);
            }

            const data = await response.json();

            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');

            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
            progressMessage.textContent = data.message;

            if (data.status === 'completed') {
                displayResults(data.result);
                resetUI();
            } else if (data.status === 'error') {
                showError(data.message);
                resetUI();
            } else {
                progressCheckInterval = setTimeout(checkProgress, 1000);
            }
        } catch (error) {
            console.error('Error checking progress:', error);
            progressCheckInterval = setTimeout(checkProgress, 2000);
        }
    }

    function displayResults(result) {
        currentResult = result;
        document.getElementById('fullText').textContent = result.full_text;
        document.getElementById('srtText').textContent = result.srt_subtitles;
        
        const wordCount = result.full_text.split(' ').length;
        const charCount = result.full_text.length;
        const avgSegmentWords = (wordCount / result.segments_count).toFixed(1);
        
        const infoText = `üìä Language: ${result.detected_language} | Segments: ${result.segments_count} | Words: ~${wordCount} | Characters: ${charCount} | Avg: ${avgSegmentWords} words/segment`;
        document.getElementById('resultInfo').textContent = infoText;
        
        progressSection.style.display = 'none';
        resultSection.style.display = 'block';
    }

    function showTab(tabName) {
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.result-content');
        
        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));

        if (tabName === 'full') {
            tabs[0].classList.add('active');
            document.getElementById('fullTextContent').classList.add('active');
        } else if (tabName === 'srt') {
            tabs[1].classList.add('active');
            document.getElementById('srtContent').classList.add('active');
        }
    }

    function copyText(type) {
        let text;
        if (type === 'full') {
            text = document.getElementById('fullText').textContent;
        } else if (type === 'srt') {
            text = document.getElementById('srtText').textContent;
        }

        navigator.clipboard.writeText(text).then(() => {
            alert('Text copied!');
        });
    }

    function downloadText(type) {
        let text, filename, mimeType;
        
        const originalFileName = selectedFile ? selectedFile.name.split('.').slice(0, -1).join('.') : 'transcription';
        
        if (type === 'full') {
            text = document.getElementById('fullText').textContent;
            filename = originalFileName + '.txt';
            mimeType = 'text/plain';
        } else if (type === 'srt') {
            text = document.getElementById('srtText').textContent;
            filename = originalFileName + '.srt';
            mimeType = 'text/plain';
        }

        const blob = new Blob([text], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>